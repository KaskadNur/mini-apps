<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ */

        .market-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .buy-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .buy-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .time-ago {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <!-- –í–µ—Å—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π HTML –æ—Å—Ç–∞–µ—Ç—Å—è -->

    <!-- –í–∫–ª–∞–¥–∫–∞ –ú–∞—Ä–∫–µ—Ç -->
    <div id="tab-market" class="tab-content">
        <div class="card">
            <h3 style="text-align: center; margin-bottom: 15px;">üõçÔ∏è –¢–æ—Ä–≥–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞</h3>
            <p style="text-align: center; margin-bottom: 15px; opacity: 0.8;">
                –ü–æ–∫—É–ø–∞–π—Ç–µ –∏ –ø—Ä–æ–¥–∞–≤–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
            </p>
            
            <div class="stars-balance">
                <div class="stars-icon">‚≠ê</div>
                <div class="stars-amount" id="marketBalance">0</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px;">üîç –§–∏–ª—å—Ç—Ä—ã</h3>
            <div class="market-filters">
                <button class="filter-btn active" onclick="setMarketFilter('all')">–í—Å–µ</button>
                <button class="filter-btn" onclick="setMarketFilter('sticker')">–°—Ç–∏–∫–µ—Ä—ã</button>
                <button class="filter-btn" onclick="setMarketFilter('avatar')">–ê–≤–∞—Ç–∞—Ä–∫–∏</button>
                <button class="filter-btn" onclick="setMarketFilter('boost')">–ë—É—Å—Ç—ã</button>
                <button class="filter-btn" onclick="setMarketFilter('cheap')">–î–µ—à–µ–≤—ã–µ</button>
                <button class="filter-btn" onclick="setMarketFilter('expensive')">–î–æ—Ä–æ–≥–∏–µ</button>
            </div>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom: 15px;">üî• –¢–æ–≤–∞—Ä—ã –Ω–∞ –º–∞—Ä–∫–µ—Ç–µ</h3>
            <div id="marketItemsList">
                <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom: 15px;">üìà –ù–µ–¥–∞–≤–Ω–∏–µ —Å–¥–µ–ª–∫–∏</h3>
            <div id="recentSales">
                <!-- –ù–µ–¥–∞–≤–Ω–∏–µ —Å–¥–µ–ª–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üõí –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞</h3>
                <button class="modal-close" onclick="closeBuyModal()">√ó</button>
            </div>
            
            <div id="buyItemInfo" style="text-align: center; margin-bottom: 20px;">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—É–ø–∞–µ–º–æ–º –ø—Ä–µ–¥–º–µ—Ç–µ -->
            </div>
            
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>–¶–µ–Ω–∞:</span>
                    <span style="font-weight: bold; color: gold;" id="buyPrice">0 ‚≠ê</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>–ö–æ–º–∏—Å—Å–∏—è (5%):</span>
                    <span style="color: #ff6b6b;" id="buyCommission">0 ‚≠ê</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span>–í–∞—à –±–∞–ª–∞–Ω—Å:</span>
                    <span style="font-weight: bold;" id="buyerBalance">0 ‚≠ê</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; padding-top: 10px; border-top: 1px solid var(--border-color);">
                    <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                    <span style="color: gold;" id="buyTotal">0 ‚≠ê</span>
                </div>
            </div>
            
            <button class="btn btn-success" id="confirmBuyBtn" onclick="confirmPurchase()">
                ‚úÖ –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å
            </button>
            <button class="btn btn-secondary" onclick="closeBuyModal()" style="margin-top: 10px;">
                ‚ùå –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let userId = null;
        let currentTheme = 'dark';
        let selectedItemIndex = null;
        let selectedMarketItem = null;
        let currentMarketFilter = 'all';
        let userData = {};
        let marketItems = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        const user = tg.initDataUnsafe.user;
        if (user) {
            userId = user.id;
            initializeApp();
        }

        async function initializeApp() {
            await loadUserData();
            await loadMarketItems();
            initializeInventory();
            updateDisplay();
        }

        async function loadUserData() {
            try {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API
                // const response = await fetch(`/api/user/${userId}`);
                // userData = await response.json();
                
                // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                userData = {
                    userId: userId,
                    balance: 125,
                    totalEarned: 145,
                    referrals: [],
                    tasksCompleted: 8,
                    referralCode: 'EARN7X9K',
                    joinDate: new Date().toISOString(),
                    inventory: [
                        { 
                            id: 1, 
                            type: 'sticker', 
                            name: '–°—Ç–∏–∫–µ—Ä–ø–∞–∫ Premium', 
                            rarity: 'rare', 
                            image: 'üé®', 
                            basePrice: 50 
                        },
                        { 
                            id: 2, 
                            type: 'boost', 
                            name: '–ë—É—Å—Ç x2', 
                            rarity: 'uncommon', 
                            image: 'üíé', 
                            basePrice: 30 
                        },
                        { 
                            id: 3, 
                            type: 'avatar', 
                            name: '–ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞', 
                            rarity: 'epic', 
                            image: 'üëë', 
                            basePrice: 100 
                        }
                    ]
                };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }

        async function loadMarketItems() {
            try {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API
                // const response = await fetch('/api/market/items');
                // marketItems = await response.json();
                
                // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                marketItems = [
                    {
                        id: 1001,
                        item: { 
                            id: 1001, 
                            type: 'sticker', 
                            name: '–°—Ç–∏–∫–µ—Ä–ø–∞–∫ "Galaxy"', 
                            rarity: 'epic', 
                            image: 'üåå', 
                            basePrice: 80 
                        },
                        sellerId: 'test_user_1',
                        sellerName: 'GalaxyTrader',
                        price: 75,
                        createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
                        sold: false
                    },
                    {
                        id: 1002,
                        item: { 
                            id: 1002, 
                            type: 'avatar', 
                            name: '–ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Ä–∞–º–∫–∞', 
                            rarity: 'rare', 
                            image: '‚ú®', 
                            basePrice: 120 
                        },
                        sellerId: 'test_user_2',
                        sellerName: 'FrameMaster',
                        price: 110,
                        createdAt: new Date(Date.now() - 30 * 60 * 1000).toISOString(), // 30 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
                        sold: false
                    },
                    {
                        id: 1003,
                        item: { 
                            id: 1003, 
                            type: 'boost', 
                            name: '–ë—É—Å—Ç x3 –Ω–∞ 48—á', 
                            rarity: 'legendary', 
                            image: 'üöÄ', 
                            basePrice: 150 
                        },
                        sellerId: 'test_user_3',
                        sellerName: 'BoostSeller',
                        price: 140,
                        createdAt: new Date(Date.now() - 5 * 60 * 1000).toISOString(), // 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
                        sold: false
                    }
                ];
                
                updateMarketDisplay();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∫–µ—Ç–∞:', error);
            }
        }

        function updateMarketDisplay() {
            const marketItemsList = document.getElementById('marketItemsList');
            const filteredItems = filterMarketItems(marketItems);
            
            if (filteredItems.length === 0) {
                marketItemsList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; opacity: 0.7;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üõí</div>
                        <div>–ü–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–µ</div>
                    </div>
                `;
                return;
            }
            
            marketItemsList.innerHTML = filteredItems.map(item => `
                <div class="market-item">
                    <div class="market-item-image">${item.item.image}</div>
                    <div class="market-item-info">
                        <div class="market-item-name">${item.item.name}</div>
                        <div class="market-item-seller">–ü—Ä–æ–¥–∞–≤–µ—Ü: ${item.sellerName}</div>
                        <div class="time-ago">${getTimeAgo(item.createdAt)}</div>
                        <div class="item-actions">
                            <button class="action-btn" style="background: #667eea; color: white;" 
                                    onclick="showItemDetails(${item.id})">
                                ‚ÑπÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                            <button class="action-btn" style="background: #28a745; color: white;" 
                                    onclick="openBuyModal(${item.id})"
                                    ${userData.balance < item.price ? 'disabled' : ''}>
                                üõí ${item.price} ‚≠ê
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('marketBalance').textContent = userData.balance;
        }

        function filterMarketItems(items) {
            const availableItems = items.filter(item => !item.sold);
            
            switch(currentMarketFilter) {
                case 'sticker':
                    return availableItems.filter(item => item.item.type === 'sticker');
                case 'avatar':
                    return availableItems.filter(item => item.item.type === 'avatar');
                case 'boost':
                    return availableItems.filter(item => item.item.type === 'boost');
                case 'cheap':
                    return availableItems.filter(item => item.price <= 50).sort((a, b) => a.price - b.price);
                case 'expensive':
                    return availableItems.filter(item => item.price >= 100).sort((a, b) => b.price - a.price);
                default:
                    return availableItems;
            }
        }

        function setMarketFilter(filter) {
            currentMarketFilter = filter;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateMarketDisplay();
        }

        function openBuyModal(marketItemId) {
            selectedMarketItem = marketItems.find(item => item.id === marketItemId);
            if (!selectedMarketItem) return;
            
            const modal = document.getElementById('buyModal');
            const itemInfo = document.getElementById('buyItemInfo');
            const commission = Math.floor(selectedMarketItem.price * 0.05);
            const total = selectedMarketItem.price;
            
            itemInfo.innerHTML = `
                <div style="font-size: 40px; margin-bottom: 10px;">${selectedMarketItem.item.image}</div>
                <div style="font-weight: bold; font-size: 18px;">${selectedMarketItem.item.name}</div>
                <div style="font-size: 14px; opacity: 0.8;">${getRarityName(selectedMarketItem.item.rarity)}</div>
                <div style="font-size: 12px; margin-top: 5px;">–û—Ç: ${selectedMarketItem.sellerName}</div>
            `;
            
            document.getElementById('buyPrice').textContent = selectedMarketItem.price + ' ‚≠ê';
            document.getElementById('buyCommission').textContent = commission + ' ‚≠ê';
            document.getElementById('buyerBalance').textContent = userData.balance + ' ‚≠ê';
            document.getElementById('buyTotal').textContent = total + ' ‚≠ê';
            
            const confirmBtn = document.getElementById('confirmBuyBtn');
            if (userData.balance < total) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥';
            } else {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '‚úÖ –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å';
            }
            
            modal.style.display = 'block';
        }

        function closeBuyModal() {
            document.getElementById('buyModal').style.display = 'none';
            selectedMarketItem = null;
        }

        async function confirmPurchase() {
            if (!selectedMarketItem || userData.balance < selectedMarketItem.price) {
                showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏');
                return;
            }
            
            try {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API
                // const response = await fetch('/api/market/buy', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({
                //         userId: userId,
                //         itemId: selectedMarketItem.id
                //     })
                // });
                // const result = await response.json();
                
                // –ò–º–∏—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–π –ø–æ–∫—É–ø–∫–∏
                const result = {
                    success: true,
                    item: selectedMarketItem.item,
                    price: selectedMarketItem.price,
                    commission: Math.floor(selectedMarketItem.price * 0.05)
                };
                
                if (result.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                    userData.balance -= selectedMarketItem.price;
                    userData.inventory.push(result.item);
                    
                    // –ü–æ–º–µ—á–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç –∫–∞–∫ –ø—Ä–æ–¥–∞–Ω–Ω—ã–π
                    selectedMarketItem.sold = true;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    updateDisplay();
                    initializeInventory();
                    updateMarketDisplay();
                    closeBuyModal();
                    
                    showNotification(`üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –∫—É–ø–∏–ª–∏ "${result.item.name}" –∑–∞ ${result.price} ‚≠ê`);
                    
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ø—Ä–µ–¥–º–µ—Ç–∞');
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (initializeInventory, handleItemClick, openSellModal, etc.)
        // ...

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = now - time;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `${days} –¥. –Ω–∞–∑–∞–¥`;
            if (hours > 0) return `${hours} —á. –Ω–∞–∑–∞–¥`;
            if (minutes > 0) return `${minutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
            return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        }

        function showItemDetails(marketItemId) {
            const item = marketItems.find(item => item.id === marketItemId);
            if (!item) return;
            
            showNotification(`‚ÑπÔ∏è ${item.item.name} - ${getRarityName(item.item.rarity)} - ${item.price} ‚≠ê`);
        }

        // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (switchTab, toggleTheme, completeTask, copyReferralLink, showNotification) –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        // ...
    </script>
</body>
</html>
